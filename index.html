<script>
    // -----------------------------
    // Food Database
    // -----------------------------
    const foodDatabase = {
        // Indian Breads & Rice
        roti: { name: 'Roti (1 piece)', baseCals: 100, protein: 3, carbs: 18, fat: 1.5 },
        parantha: { name: 'Parantha (1 piece)', baseCals: 150, protein: 5, carbs: 22, fat: 5 },
        naan: { name: 'Naan (1 piece)', baseCals: 180, protein: 6, carbs: 28, fat: 6 },
        rice_plain: { name: 'Plain Rice (1 bowl)', baseCals: 120, protein: 2.5, carbs: 28, fat: 0.3 },
        basmati_rice: { name: 'Basmati Rice (1 cup)', baseCals: 190, protein: 4, carbs: 42, fat: 1.5 },
        
        // South Indian
        dosa: { name: 'Dosa (plain)', baseCals: 250, protein: 8, carbs: 48, fat: 3 },
        masala_dosa: { name: 'Masala Dosa', baseCals: 320, protein: 9, carbs: 52, fat: 8 },
        idli: { name: 'Idli (2 pieces)', baseCals: 100, protein: 2, carbs: 18, fat: 1 },
        uttapam: { name: 'Uttapam (1 piece)', baseCals: 180, protein: 5, carbs: 32, fat: 3 },
        sambar_rice: { name: 'Sambar Rice (1 bowl)', baseCals: 380, protein: 10, carbs: 68, fat: 4 },
        curd_rice: { name: 'Curd Rice (1 bowl)', baseCals: 180, protein: 8, carbs: 28, fat: 3 },
        
        // Curries & Meat
        paneer_curry: { name: 'Paneer Curry (1 bowl)', baseCals: 320, protein: 20, carbs: 12, fat: 22 },
        butter_chicken: { name: 'Butter Chicken (1 bowl)', baseCals: 490, protein: 28, carbs: 15, fat: 35 },
        tandoori_chicken: { name: 'Tandoori Chicken (150g)', baseCals: 260, protein: 40, carbs: 2, fat: 10 },
        chicken_curry: { name: 'Chicken Curry (1 bowl)', baseCals: 225, protein: 30, carbs: 4, fat: 10 },
        biryani_chicken: { name: 'Chicken Biryani (1 plate)', baseCals: 450, protein: 18, carbs: 56, fat: 14 },
        dal_makhani: { name: 'Dal Makhani (1 bowl)', baseCals: 320, protein: 15, carbs: 30, fat: 14 },
        fish_curry: { name: 'Fish Curry (1 bowl)', baseCals: 220, protein: 28, carbs: 5, fat: 10 },
        egg_curry: { name: 'Egg Curry (2 eggs)', baseCals: 280, protein: 18, carbs: 8, fat: 20 },
        
        // Vegetables & Sides
        aloo_gobi: { name: 'Aloo Gobi (1 bowl)', baseCals: 110, protein: 3, carbs: 18, fat: 3 },
        bindi_fry: { name: 'Bindi Fry (1 bowl)', baseCals: 120, protein: 4, carbs: 15, fat: 4 },
        cauliflower_fry: { name: 'Cauliflower Fry (1 bowl)', baseCals: 140, protein: 5, carbs: 12, fat: 6 },
        dal_tadka: { name: 'Dal Tadka (1 bowl)', baseCals: 200, protein: 12, carbs: 28, fat: 4 },
        rajma: { name: 'Rajma (1 bowl)', baseCals: 240, protein: 14, carbs: 36, fat: 3 },
        
        // Snacks
        samosa: { name: 'Samosa (1 piece)', baseCals: 150, protein: 3, carbs: 18, fat: 7 },
        pakora: { name: 'Pakora (5 pieces)', baseCals: 200, protein: 4, carbs: 22, fat: 10 },
        chikhalwali: { name: 'Chikhalwali (1 piece)', baseCals: 180, protein: 5, carbs: 20, fat: 8 },
        spring_roll: { name: 'Spring Roll (1 piece)', baseCals: 160, protein: 4, carbs: 18, fat: 7 },
        
        // Sweets & Dairy
        curd: { name: 'Curd/Yogurt (1 cup)', baseCals: 100, protein: 10, carbs: 8, fat: 3.5 },
        paneer: { name: 'Paneer (100g)', baseCals: 300, protein: 28, carbs: 3, fat: 22 },
        gulab_jamun: { name: 'Gulab Jamun (2 pieces)', baseCals: 280, protein: 2, carbs: 42, fat: 11 },
        kheer: { name: 'Kheer (1 bowl)', baseCals: 250, protein: 8, carbs: 35, fat: 8 },
        
        // Beverages & Supplements
        protein_shake: { name: 'Protein Shake (250ml)', baseCals: 150, protein: 25, carbs: 3, fat: 2 },
        milk: { name: 'Milk (1 cup)', baseCals: 150, protein: 8, carbs: 12, fat: 8 },
        coconut_water: { name: 'Coconut Water (1 cup)', baseCals: 45, protein: 1.5, carbs: 9, fat: 0.5 },
        lassi: { name: 'Lassi (1 glass)', baseCals: 180, protein: 8, carbs: 28, fat: 3 },
        
        // International
        pizza: { name: 'Pizza (1 slice)', baseCals: 280, protein: 10, carbs: 32, fat: 12 },
        burger: { name: 'Burger', baseCals: 350, protein: 15, carbs: 35, fat: 16 },
        pasta: { name: 'Pasta (1 bowl)', baseCals: 240, protein: 8, carbs: 42, fat: 4 },
        salad: { name: 'Salad (1 bowl)', baseCals: 100, protein: 4, carbs: 12, fat: 4 },
        
        // Eggs & Proteins
        boiled_eggs: { name: 'Boiled Eggs (2 pieces)', baseCals: 180, protein: 18, carbs: 1, fat: 10 },
        scrambled_eggs: { name: 'Scrambled Eggs (2 pieces)', baseCals: 200, protein: 18, carbs: 2, fat: 12 },
        chicken_breast: { name: 'Grilled Chicken Breast (150g)', baseCals: 210, protein: 42, carbs: 0, fat: 4 },
        
        // Fruits
        banana: { name: 'Banana (1 medium)', baseCals: 105, protein: 1.3, carbs: 27, fat: 0.3 },
        apple: { name: 'Apple (1 medium)', baseCals: 95, protein: 0.5, carbs: 25, fat: 0.3 },
        orange: { name: 'Orange (1 medium)', baseCals: 85, protein: 1.7, carbs: 21, fat: 0.2 },
        mango: { name: 'Mango (100g)', baseCals: 60, protein: 0.8, carbs: 15, fat: 0.4 }
    };

    // -----------------------------
    // Data Structures
    // -----------------------------
    let users = [];
    let currentUserId = null;

    let todayData = {
        foods: [],
        workouts: [],
        dailyGoal: 2000,
        proteinGoal: 150,
        carbsGoal: 250,
        fatGoal: 70
    };

    // -----------------------------
    // User Helpers
    // -----------------------------
    function getCurrentUser() {
        return users.find(u => u.id === currentUserId) || users[0];
    }

    function syncCurrentUserData() {
        const user = getCurrentUser();
        if (!user) return;
        todayData = {
            foods: user.foods || [],
            workouts: user.workouts || [],
            dailyGoal: user.dailyGoal || 2200,
            proteinGoal: user.proteinGoal || 150,
            carbsGoal: user.carbsGoal || 250,
            fatGoal: user.fatGoal || 70
        };
    }

    function saveCurrentUserData() {
        const user = getCurrentUser();
        if (!user) return;
        user.foods = todayData.foods;
        user.workouts = todayData.workouts;
        user.dailyGoal = todayData.dailyGoal;
        user.proteinGoal = todayData.proteinGoal;
        user.carbsGoal = todayData.carbsGoal;
        user.fatGoal = todayData.fatGoal;
    }

    function switchUser(userId) {
        currentUserId = userId;
        syncCurrentUserData();
        updateDisplay();
        updateUsersList();
    }

    // -----------------------------
    // BMR / TDEE
    // -----------------------------
    function calculateBMR(weight, height, age, gender) {
        if (gender === 'male') {
            return 10 * weight + 6.25 * height - 5 * age + 5;
        } else {
            return 10 * weight + 6.25 * height - 5 * age - 161;
        }
    }

    function calculateTDEE(bmr, activityLevel) {
        const activityMultipliers = {
            sedentary: 1.2,
            light: 1.375,
            moderate: 1.55,
            active: 1.725,
            very_active: 1.9
        };
        return bmr * (activityMultipliers[activityLevel] || 1.55);
    }

    function getActivityMultiplier(activityLevel) {
        const multipliers = {
            sedentary: 1.2,
            light: 1.375,
            moderate: 1.55,
            active: 1.725,
            very_active: 1.9
        };
        return multipliers[activityLevel] || 1.55;
    }

    // -----------------------------
    // Add New User
    // -----------------------------
    function addNewUser() {
        const name = document.getElementById('userName').value.trim();
        const email = document.getElementById('userEmail').value.trim();
        const height = parseFloat(document.getElementById('userHeight').value);
        const weight = parseFloat(document.getElementById('userWeight').value);
        const gender = document.getElementById('userGender').value;
        const age = parseFloat(document.getElementById('userAge').value);
        const wakeTime = document.getElementById('userWakeTime').value;
        const sleepTime = document.getElementById('userSleepTime').value;
        const activityLevel = document.getElementById('userActivity').value;

        if (!name || !height || !weight || !gender || !age || !wakeTime || !sleepTime || !activityLevel) {
            alert('Please fill in all required fields');
            return;
        }

        const bmr = calculateBMR(weight, height, age, gender);
        const activityMultiplier = getActivityMultiplier(activityLevel);
        const dailyGoal = Math.round(bmr * activityMultiplier);

        const proteinGoal = Math.round(weight * 1.8);
        const carbsGoal = Math.round((dailyGoal * 0.45) / 4);
        const fatGoal = Math.round((dailyGoal * 0.25) / 9);

        const newUser = {
            id: Date.now(),
            name,
            email,
            height,
            weight,
            gender,
            age,
            wakeTime,
            sleepTime,
            activityLevel,
            createdDate: new Date().toLocaleDateString(),
            dailyGoal,
            proteinGoal,
            carbsGoal,
            fatGoal,
            foods: [],
            workouts: []
        };

        users.push(newUser);
        currentUserId = newUser.id;
        syncCurrentUserData();

        // Clear form
        document.getElementById('userName').value = '';
        document.getElementById('userEmail').value = '';
        document.getElementById('userHeight').value = '';
        document.getElementById('userWeight').value = '';
        document.getElementById('userGender').value = '';
        document.getElementById('userAge').value = '';
        document.getElementById('userWakeTime').value = '';
        document.getElementById('userSleepTime').value = '';
        document.getElementById('userActivity').value = '';

        updateDisplay();
        updateUsersList();
        switchTab('add-food');
    }

    function deleteUser(userId) {
        if (!confirm('Delete this user profile?')) return;
        if (users.length <= 1) {
            alert('Cannot delete the only user');
            return;
        }
        users = users.filter(u => u.id !== userId);
        if (currentUserId === userId && users.length > 0) {
            currentUserId = users[0].id;
            syncCurrentUserData();
        }
        updateUsersList();
        updateDisplay();
    }

    function updateUsersList() {
        const container = document.getElementById('usersContainer');
        if (!container) return;

        if (users.length === 0) {
            container.innerHTML = '<p style="color: var(--color-text-secondary); font-size: 0.9em;">No users yet. Create a profile to get started!</p>';
            return;
        }

        container.innerHTML = users.map(user => `
            <div style="background: ${currentUserId === user.id ? 'rgba(56, 189, 248, 0.15)' : 'rgba(255, 255, 255, 0.03)'}; border: 1px solid ${currentUserId === user.id ? 'rgba(56, 189, 248, 0.5)' : 'rgba(255, 255, 255, 0.1)'}; padding: 15px; margin-bottom: 12px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;" onclick="switchUser(${user.id})">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--color-text-primary); margin-bottom: 6px; font-size: 1.1em;">${user.name}</div>
                        <div style="font-size: 0.8em; color: var(--color-text-secondary); margin-bottom: 8px;">
                            üìä ${user.height}cm ‚Ä¢ ${user.weight}kg | üéÇ Age ${user.age} (${user.gender || 'N/A'})
                        </div>
                        <div style="font-size: 0.8em; color: var(--color-text-secondary); margin-bottom: 8px;">
                            ‚è∞ Wake: ${user.wakeTime} | üò¥ Sleep: ${user.sleepTime}
                        </div>
                        <div style="font-size: 0.8em; color: var(--color-text-secondary); margin-bottom: 8px;">
                            üí™ Activity: ${user.activityLevel.replace('_', ' ')} | üéØ Daily Goal: ${user.dailyGoal} cal
                        </div>
                        <div style="font-size: 0.75em; color: var(--color-text-secondary);">
                            Created: ${user.createdDate}
                        </div>
                    </div>
                    <button class="btn-small btn-danger" onclick="event.stopPropagation(); deleteUser(${user.id})" style="flex: 0 0 auto; margin-left: 10px;">Delete</button>
                </div>
            </div>
        `).join('');
    }

    // -----------------------------
    // Food Handling
    // -----------------------------
    function updateFoodEstimate() {
        const foodSelect = document.getElementById('foodSelect').value;
        const portionSize = parseFloat(document.getElementById('portionSize').value) || 1;
        const portionControls = document.getElementById('portionControls');
        const customFoodInput = document.getElementById('customFoodInput');
        const macroInputs = document.getElementById('macroInputs');

        if (foodSelect === 'custom') {
            portionControls.style.display = 'none';
            customFoodInput.style.display = 'block';
            macroInputs.style.display = 'flex';
            document.getElementById('calorieEstimate').textContent = 'Est: 0 cal';
            return;
        }

        if (!foodSelect) {
            portionControls.style.display = 'none';
            customFoodInput.style.display = 'none';
            macroInputs.style.display = 'none';
            document.getElementById('calorieEstimate').textContent = 'Est: 0 cal';
            return;
        }

        const food = foodDatabase[foodSelect];
        if (!food) return;

        portionControls.style.display = 'flex';
        customFoodInput.style.display = 'none';
        macroInputs.style.display = 'none';

        const estimatedCals = Math.round(food.baseCals * portionSize);
        document.getElementById('calorieEstimate').textContent = `Est: ${estimatedCals} cal`;
    }

    function addFood() {
        const foodSelect = document.getElementById('foodSelect').value;
        let name, calories, protein, carbs, fat;

        if (foodSelect === 'custom' || !foodSelect) {
            name = document.getElementById('foodName').value.trim();
            calories = parseFloat(document.getElementById('foodCalories').value);
            protein = parseFloat(document.getElementById('foodProtein').value) || 0;
            carbs = parseFloat(document.getElementById('foodCarbs').value) || 0;
            fat = parseFloat(document.getElementById('foodFat').value) || 0;

            if (!name || isNaN(calories) || calories <= 0) {
                alert('Please enter food name and calories');
                return;
            }
        } else {
            const portionSize = document.getElementById('portionSize').value;
            if (!portionSize) {
                alert('Please select a portion size');
                return;
            }
            const food = foodDatabase[foodSelect];
            const multiplier = parseFloat(portionSize);
            name = food.name;
            calories = Math.round(food.baseCals * multiplier);
            protein = Math.round(food.protein * multiplier * 10) / 10;
            carbs = Math.round(food.carbs * multiplier * 10) / 10;
            fat = Math.round(food.fat * multiplier * 10) / 10;
        }

        const foodEntry = {
            id: Date.now(),
            name,
            calories,
            protein,
            carbs,
            fat,
            time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
        };

        todayData.foods.push(foodEntry);
        saveCurrentUserData();

        showSuccessMessage('foodAddedMessage');

        document.getElementById('foodSelect').value = '';
        document.getElementById('portionSize').value = '';
        document.getElementById('foodName').value = '';
        document.getElementById('foodCalories').value = '';
        document.getElementById('foodProtein').value = '';
        document.getElementById('foodCarbs').value = '';
        document.getElementById('foodFat').value = '';
        document.getElementById('portionControls').style.display = 'none';
        document.getElementById('customFoodInput').style.display = 'none';
        document.getElementById('macroInputs').style.display = 'flex';

        updateDisplay();
    }

    function quickAddFood(name, calories, protein, carbs, fat) {
        const foodEntry = {
            id: Date.now(),
            name,
            calories,
            protein,
            carbs,
            fat,
            time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
        };
        todayData.foods.push(foodEntry);
        saveCurrentUserData();
        showSuccessMessage('foodAddedMessage');
        updateDisplay();
    }

    function removeFood(id) {
        todayData.foods = todayData.foods.filter(f => f.id !== id);
        saveCurrentUserData();
        updateDisplay();
    }

    // -----------------------------
    // Workout Handling
    // -----------------------------
    function addWorkout() {
        const name = document.getElementById('workoutName').value.trim();
        const duration = parseFloat(document.getElementById('workoutDuration').value);
        const calories = parseFloat(document.getElementById('workoutCalories').value);
        const intensity = document.getElementById('workoutIntensity').value;

        if (!name || isNaN(duration) || isNaN(calories) || calories <= 0) {
            alert('Please fill in all workout fields');
            return;
        }

        const workoutEntry = {
            id: Date.now(),
            name,
            duration,
            calories: Math.round(calories),
            intensity,
            time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
        };

        todayData.workouts.push(workoutEntry);
        saveCurrentUserData();
        showSuccessMessage('workoutAddedMessage');

        document.getElementById('workoutName').value = '';
        document.getElementById('workoutDuration').value = '';
        document.getElementById('workoutCalories').value = '';
        document.getElementById('workoutIntensity').value = 'moderate';

        updateDisplay();
    }

    function quickAddWorkout(name, duration, calories, intensity) {
        const workoutEntry = {
            id: Date.now(),
            name,
            duration,
            calories: Math.round(calories),
            intensity,
            time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
        };
        todayData.workouts.push(workoutEntry);
        saveCurrentUserData();
        showSuccessMessage('workoutAddedMessage');
        updateDisplay();
    }

    function removeWorkout(id) {
        todayData.workouts = todayData.workouts.filter(w => w.id !== id);
        saveCurrentUserData();
        updateDisplay();
    }

    // -----------------------------
    // Goals & Presets
    // -----------------------------
    function updateGoal() {
        const newGoal = parseFloat(document.getElementById('calorieGoal').value);
        if (isNaN(newGoal) || newGoal < 1000) {
            alert('Please enter a valid calorie goal');
            return;
        }
        todayData.dailyGoal = newGoal;
        saveCurrentUserData();
        updateDisplay();
    }

    function updateMacros() {
        const protein = parseFloat(document.getElementById('proteinGoalInput').value);
        const carbs = parseFloat(document.getElementById('carbsGoalInput').value);
        const fat = parseFloat(document.getElementById('fatGoalInput').value);

        if (isNaN(protein) || isNaN(carbs) || isNaN(fat)) {
            alert('Please enter valid macro goals');
            return;
        }

        todayData.proteinGoal = protein;
        todayData.carbsGoal = carbs;
        todayData.fatGoal = fat;
        saveCurrentUserData();
        updateDisplay();
    }

    function setPreset(preset) {
        const user = getCurrentUser();
        if (!user) return;

        const baseCalories = calculateTDEE(
            calculateBMR(user.weight, user.height, user.age, user.gender),
            user.activityLevel
        );

        if (preset === 'cut') {
            todayData.dailyGoal = Math.round(baseCalories * 0.85);
            todayData.proteinGoal = Math.round(user.weight * 2.2);
        } else if (preset === 'maintain') {
            todayData.dailyGoal = Math.round(baseCalories);
            todayData.proteinGoal = Math.round(user.weight * 1.8);
        } else if (preset === 'bulk') {
            todayData.dailyGoal = Math.round(baseCalories * 1.1);
            todayData.proteinGoal = Math.round(user.weight * 2.0);
        }

        todayData.carbsGoal = Math.round((todayData.dailyGoal * 0.45) / 4);
        todayData.fatGoal = Math.round((todayData.dailyGoal * 0.3) / 9);

        saveCurrentUserData();
        updateDisplay();
    }

    function resetAllData() {
        if (!confirm('Are you sure you want to reset all data? This cannot be undone.')) return;
        todayData = {
            foods: [],
            workouts: [],
            dailyGoal: 2000,
            proteinGoal: 150,
            carbsGoal: 250,
            fatGoal: 70
        };
        saveCurrentUserData();
        updateDisplay();
    }

    // -----------------------------
    // Totals & Display
    // -----------------------------
    function calculateTotals() {
        const totals = {
            calories: 0,
            protein: 0,
            carbs: 0,
            fat: 0,
            burned: 0
        };

        todayData.foods.forEach(food => {
            totals.calories += food.calories || 0;
            totals.protein += food.protein || 0;
            totals.carbs += food.carbs || 0;
            totals.fat += food.fat || 0;
        });

        todayData.workouts.forEach(workout => {
            totals.burned += workout.calories || 0;
        });

        return totals;
    }

    function updateFoodList() {
        const container = document.getElementById('foodListContainer');
        if (!container) return;

        if (todayData.foods.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üçΩÔ∏è</div>
                    <p>No foods logged yet. Start by adding your meals!</p>
                </div>
            `;
            return;
        }

        container.innerHTML = todayData.foods.map(food => `
            <div class="food-item">
                <div class="food-details">
                    <div class="food-name">${food.name}</div>
                    <div class="food-calories">
                        <span class="food-calories-value">${Math.round(food.calories)} cal</span> ‚Ä¢ 
                        P: ${Math.round(food.protein)}g ‚Ä¢ C: ${Math.round(food.carbs)}g ‚Ä¢ F: ${Math.round(food.fat)}g ‚Ä¢ ${food.time}
                    </div>
                </div>
                <button class="btn-small btn-danger" onclick="removeFood(${food.id})">Remove</button>
            </div>
        `).join('');
    }

    function updateWorkoutList() {
        const container = document.getElementById('workoutListContainer');
        if (!container) return;

        if (todayData.workouts.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üí™</div>
                    <p>No workouts logged yet. Great job planning your gym session!</p>
                </div>
            `;
            return;
        }

        container.innerHTML = todayData.workouts.map(workout => `
            <div class="workout-item">
                <div class="workout-details">
                    <div class="workout-name">${workout.name}</div>
                    <div class="workout-burned">
                        ${workout.duration} min ‚Ä¢ ${Math.round(workout.calories)} cal burned (${workout.intensity}) ‚Ä¢ ${workout.time}
                    </div>
                </div>
                <button class="btn-small btn-danger" onclick="removeWorkout(${workout.id})">Remove</button>
            </div>
        `).join('');
    }

    function updateDisplay() {
        const totals = calculateTotals();
        const netCalories = totals.calories - totals.burned;
        const remaining = todayData.dailyGoal - totals.calories;

        // Dashboard
        document.getElementById('caloriesSummary').textContent = Math.round(totals.calories);
        document.getElementById('dailyGoalDisplay').textContent = todayData.dailyGoal;
        const remainingElement = document.getElementById('remaining');
        remainingElement.textContent = `${remaining >= 0 ? '+' : ''}${remaining} remaining`;
        remainingElement.style.color = remaining >= 0 ? 'var(--color-primary)' : 'var(--color-warning)';

        document.getElementById('caloriesBurned').textContent = Math.round(totals.burned);
        document.getElementById('workoutCount').textContent = todayData.workouts.length;

        // Goals inputs
        document.getElementById('calorieGoal').value = todayData.dailyGoal;
        document.getElementById('proteinGoalDisplay').textContent = todayData.proteinGoal + 'g';
        document.getElementById('carbsGoalDisplay').textContent = todayData.carbsGoal + 'g';
        document.getElementById('fatGoalDisplay').textContent = todayData.fatGoal + 'g';
        document.getElementById('proteinGoalInput').value = todayData.proteinGoal;
        document.getElementById('carbsGoalInput').value = todayData.carbsGoal;
        document.getElementById('fatGoalInput').value = todayData.fatGoal;

        // Macros
        document.getElementById('totalProtein').textContent = Math.round(totals.protein);
        document.getElementById('totalCarbs').textContent = Math.round(totals.carbs);
        document.getElementById('totalFat').textContent = Math.round(totals.fat);

        const proteinPercent = todayData.proteinGoal ? Math.min((totals.protein / todayData.proteinGoal) * 100, 100) : 0;
        const carbsPercent = todayData.carbsGoal ? Math.min((totals.carbs / todayData.carbsGoal) * 100, 100) : 0;
        const fatPercent = todayData.fatGoal ? Math.min((totals.fat / todayData.fatGoal) * 100, 100) : 0;

        document.getElementById('proteinBar').style.width = proteinPercent + '%';
        document.getElementById('carbsBar').style.width = carbsPercent + '%';
        document.getElementById('fatBar').style.width = fatPercent + '%';

        // History tab
        document.getElementById('historyCalories').textContent = Math.round(totals.calories);
        document.getElementById('historyBurned').textContent = Math.round(totals.burned);
        document.getElementById('historyNet').textContent = Math.round(netCalories);
        document.getElementById('historyProtein').textContent = Math.round(totals.protein);
        document.getElementById('historyCarbs').textContent = Math.round(totals.carbs);
        document.getElementById('historyFat').textContent = Math.round(totals.fat);

        // Lists
        updateFoodList();
        updateWorkoutList();
    }

    // -----------------------------
    // Misc Helpers
    // -----------------------------
    function showSuccessMessage(elementId) {
        const msg = document.getElementById(elementId);
        if (!msg) return;
        msg.classList.add('show');
        setTimeout(() => msg.classList.remove('show'), 2000);
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        const tab = document.getElementById(tabName);
        if (tab) tab.classList.add('active');

        if (event && event.target) {
            event.target.classList.add('active');
        }
    }

    // -----------------------------
    // Init
    // -----------------------------
    window.addEventListener('DOMContentLoaded', () => {
        if (users.length === 0) {
            const defaultUser = {
                id: Date.now(),
                name: 'You',
                email: '',
                height: 175,
                weight: 75,
                gender: '',
                age: 25,
                wakeTime: '08:00',
                sleepTime: '23:00',
                activityLevel: 'active',
                createdDate: new Date().toLocaleDateString(),
                dailyGoal: 2200,
                proteinGoal: 150,
                carbsGoal: 250,
                fatGoal: 70,
                foods: [],
                workouts: []
            };
            users.push(defaultUser);
        }

        if (currentUserId === null && users.length > 0) {
            currentUserId = users[0].id;
            syncCurrentUserData();
        }

        updateDisplay();
        updateUsersList();
    });
</script>
